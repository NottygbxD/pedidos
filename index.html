<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Pedido</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f5f5f5;
      padding: 20px;
    }
    table {
      width: 100%;
      margin-top: 20px;
    }
    th {
      background-color: #007bff;
      color: white;
      text-align: center;
    }
    td input {
      width: 100%;
    }
    .btn-success {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h3>Formulario de Pedido</h3>
  <div class="form-group">
    <label for="tecnico">Técnico:</label>
    <input type="text" id="tecnico" class="form-control">
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>N°</th>
        <th>Código</th>
        <th>Producto</th>
        <th>Descripción</th>
        <th>Cantidad</th>
        <th>Comentario</th>
      </tr>
    </thead>
    <tbody id="tabla">
      <tr>
        <td>1</td>
        <td><input type="text" class="codigo form-control" /></td>
        <td><input type="text" class="producto form-control" readonly /></td>
        <td><input type="text" class="descripcion form-control" readonly /></td>
        <td><input type="text" class="cantidad form-control" /></td>
        <td><input type="text" class="comentario form-control" /></td>
      </tr>
    </tbody>
  </table>

  <button class="btn btn-success" onclick="enviar()">Enviar Pedido</button>

  <script>
    const urlAPI = 'https://script.google.com/macros/s/AKfycbxjF4ZDC4tIKjO0ds70_1n93kEiZX3KtsjcbecBEWSFkFhMIDsz_chKCl8qc_rXUhmP/exec';

    function enviar() {
      const tecnico = document.getElementById("tecnico").value;
      const filas = document.querySelectorAll("#tabla tr");
      const data = [];

      filas.forEach(fila => {
        const codigo = fila.querySelector(".codigo")?.value.trim();
        const producto = fila.querySelector(".producto")?.value.trim();
        const descripcion = fila.querySelector(".descripcion")?.value.trim();
        const cantidad = fila.querySelector(".cantidad")?.value.trim();
        const comentario = fila.querySelector(".comentario")?.value.trim();

        if (codigo && producto && cantidad) {
          data.push({ tecnico, codigo, producto, descripcion, cantidad, comentario });
        }
      });

      if (data.length === 0) {
        alert("No hay datos válidos para enviar.");
        return;
      }

      fetch(urlAPI, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json",
        }
      })
        .then(res => res.json())
        .then(response => {
          if (response.ok) {
            alert("✔️ Pedido enviado correctamente");
            location.reload();
          } else {
            alert("❌ Error al enviar uno o más pedidos");
            console.error(response.error);
          }
        })
        .catch(err => {
          alert("❌ Error en la conexión");
          console.error(err);
        });
    }

    // Agregar fila nueva automáticamente
    document.getElementById("tabla").addEventListener("input", (e) => {
      const filas = document.querySelectorAll("#tabla tr");
      const ultimaFila = filas[filas.length - 1];
      const inputs = ultimaFila.querySelectorAll("input");
      const algunoLleno = [...inputs].some(input => input.value.trim() !== "");

      if (algunoLleno) {
        const nuevaFila = ultimaFila.cloneNode(true);
        nuevaFila.querySelectorAll("input").forEach(input => input.value = "");
        nuevaFila.querySelector("td").textContent = filas.length + 1;
        document.getElementById("tabla").appendChild(nuevaFila);
        agregarAutocompletado();
      }
    });

    // Autocompletar desde catálogo
    function agregarAutocompletado() {
      document.querySelectorAll(".codigo").forEach(input => {
        input.removeEventListener("change", handleCodigoChange); // evita duplicar
        input.addEventListener("change", handleCodigoChange);
      });
    }

    function handleCodigoChange(event) {
      const codigo = event.target.value.trim();
      const fila = event.target.closest("tr");
      const inputProducto = fila.querySelector(".producto");
      const inputDescripcion = fila.querySelector(".descripcion");

      fetch(`${urlAPI}?codigo=${codigo}`)
        .then(res => res.json())
        .then(data => {
          inputProducto.value = data.producto || "";
          inputDescripcion.value = data.descripcion || "";
        })
        .catch(err => {
          console.error("Error al autocompletar:", err);
        });
    }

    // Inicializar
    agregarAutocompletado();
  </script>
</body>
</html>

